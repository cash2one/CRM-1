function bootstrapAlert(a,t){return'<div class="alert alert-'+(t||"danger")+' alert-dismissable" role="alert">'+a+"</div>"+'<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'}function emailCheck(a){var t=/^([\.a-zA-Z0-9_-])+@([a-zA-Z0-9_-])+(\.[a-zA-Z0-9_-])+/;return t.test(a)}function getChecked(a){var t=[];$('input[name="'+a+'"]:checked').each(function(){t.push($(this).val())});return t.join(",")}function getCheckedArray(a){var t=[];$('input[name="'+a+'"]:checked').each(function(){t.push($(this).val())});return t}function backpage(){location.href=document.referrer}function backtopage(){history.go(-1)}function openNewWindow(a){window.open(a)}function filterEffect(){$(this).addClass("selected").siblings().removeClass("selected")}function checkSelectVal(a){if(a.children("option").length>1){return!(a.val()==="0")}else{return true}}function loading(a){var t=$("#loading");if(t){if(a){t.css("display","block")}else{t.css("display","none")}}}function checkCustomerForm(){var a=$("#type");if(!checkSelectVal(a)){a.parent().addClass("has-error");alert("请选择客户类型！");return false}var t=$("#category1");if(!checkSelectVal(t)){t.parent().addClass("has-error");alert("请选择客户客户一级类目！");return false}var e=$("#category2");if(!checkSelectVal(e)){e.parent().addClass("has-error");alert("请选择客户客户二级类目！");return false}var o=$("#category3");if(!checkSelectVal(o)){o.parent().addClass("has-error");alert("请选择客户客户三级类目！");return false}var r=$("#zone");if(r.is("select")){if(r.val()==="0"){r.parent().addClass("has-error");alert("请选择大区！");return false}}var n=$("#province");if(!checkSelectVal(n)){n.parent().addClass("has-error");alert("请选择省份！");return false}return true}function getCustomerData(){return{name:$("#name").val(),short_name:$("#short-name").val(),type:$("#type").val(),priority:$("#priority").val(),category1:$("#category1").val(),category2:$("#category2").val(),category3:$("#category3").val(),zone:$("#zone").val(),registered_capital:$("#registered-capital").val(),shareholder:$("#shareholder").val(),product_desc:$("#product-desc").val(),province:$("#province").val(),city:$("#city").val(),address:$("#address").val(),notes:$("#notes").val(),businessmans_id:getCheckedArray("businessman")}}function checkCustomerData(a){if(!a["name"]){$("#name").parent().addClass("has-error");alert("客户名称为必填项");return false}else if(!a["short_name"]){$("#short-name").parent().addClass("has-error");alert("简称为必填项");return false}else if(!$.trim(a["registered_capital"])){$("#registered-capital").parent().addClass("has-error");alert("注册资本为必填项");return false}else if(!a["shareholder"]){$("#short-name").parent().addClass("has-error");alert("股东为必填项");return false}else if(!a["product_desc"]){$("#product-desc").parent().addClass("has-error");alert("客户业务或产品描述为必填项");return false}else if(!a["city"]){$("#city").parent().addClass("has-error");alert("城市为必填项");return false}else if(!$.isNumeric(a["registered_capital"])){$("#registered-capital").parent().addClass("has-error");alert("注册资本不是一个有效的数字");return false}else{return true}}function customerAdd(){$("form").find("div.has-error").removeClass("has-error");var a=getCustomerData();if(checkCustomerData(a)){if(checkCustomerForm()){var t="/crm/ajax/customer/add/";$.post(t,JSON.stringify(a),function(a){if(a["msg"]=="0"){backpage()}else{alert(a["msg"])}})}}}function customerEdit(a){$("form").find("div.has-error").removeClass("has-error");var t=getCustomerData();t["id"]=a;if(checkCustomerData(t)){if(checkCustomerForm()){var e="/crm/ajax/customer/edit/";$.post(e,JSON.stringify(t),function(a){if(a["msg"]=="0"){backpage()}else{alert(a["msg"])}})}}}function customerView(a){var t="/crm/ajax/customer/view/";var e=$("#table-view").children("tbody");e.empty();$.getJSON(t,{customer_id:a},function(a){if(a["msg"]==0){var t=a["data"];for(var o=0;o<t.length;o++){e.append('<tr class="default"><th scope="row">'+t[o].name+"</th><td>"+t[o].value+"</td></tr>")}}else{alert(a["msg"])}})}function confirmDelCustomer(a,t){var e=$("#confirm-modal");e.modal("show");e.find(".modal-body").html("<p>确认要删除<strong>"+t+"</strong>吗？");e.find(".modal-footer button").val(a)}function customerDel(a){var t=$(a).val();var e=$("#confirm-modal");var o="/crm/ajax/customer/del/";$.getJSON(o,{customer_id:t},function(a){if(a["msg"]==0){e.modal("hide");location.reload()}else{alert(a["msg"])}})}function table_del(a){var t=$(a).val();$("#table-contact tr:eq("+t+")").remove();table_line_each()}function table_line_each(){$("#table-contact tr:gt(0)").each(function(a){$(this).children("th").html(a+1);$(this).find("button").attr("value",a+1)})}function GetTableData(a){var t=[];$(a+" tr:gt(0)").each(function(a,e){t[a]=[];$(e).find("td").each(function(e,o){t[a][e]=$(o).text()})});return t}function checkContact(a){if(!(a.name&&a.mobile)){alert("名字和手机不能为空！");return false}if(!emailCheck(a.mail)){alert("请正确填写email地址！");return false}return true}function showContactViewModal(a){var t=$("#contact-info-modal");t.modal("show");var e="/crm/ajax/contact/view/";$.getJSON(e,{contact_id:a},function(a){if(a["msg"]==0){$("#table_view tr:eq(0) td:eq(0)").html(a["name"]);$("#table_view tr:eq(1) td:eq(0)").html(a["pos"]);$("#table_view tr:eq(2) td:eq(0)").html(a["phone"]);$("#table_view tr:eq(3) td:eq(0)").html(a["mobile"]);$("#table_view tr:eq(4) td:eq(0)").html(a["mail"])}else{alert(a["msg"])}})}function show_contact_add_modal(){var a=$("#contact-add-modal");a.modal("show");a.find(".modal-body input[name='contact-name']").val("");a.find(".modal-body input[name='contact-pos']").val("");a.find(".modal-body input[name='contact-tel']").val("");a.find(".modal-body input[name='contact-mobile']").val("");a.find(".modal-body input[name='contact-mail']").val("")}function ajaxContactCreate(a){var t=$("#contact-add-modal");var e={project_id:a,name:t.find(".modal-body input[name='contact-name']").val(),pos:t.find(".modal-body input[name='contact-pos']").val(),tel:t.find(".modal-body input[name='contact-tel']").val(),mobile:t.find(".modal-body input[name='contact-mobile']").val(),mail:t.find(".modal-body input[name='contact-mail']").val()};if(checkContact(e)){var o="/crm/ajax/contact/add/";$.getJSON(o,e,function(a){if(a["msg"]==0){t.modal("hide");var e=$("#contact");e.get(0).options.add(new Option(a["contact_name"],a["contact_id"]));e.val(a["contact_id"])}else{alert(a["msg"])}})}}function contact_add(){var a=$("#contact-add-modal");var t=a.find(".modal-body input[name='contact-name']").val();var e=a.find(".modal-body input[name='contact-pos']").val();var o=a.find(".modal-body input[name='contact-tel']").val();var r=a.find(".modal-body input[name='contact-mobile']").val();var n=a.find(".modal-body input[name='contact-mail']").val();if(!(t&&r)){alert("名字和手机不能为空！");return false}if(!emailCheck(n)){alert("请正确填写email地址！");return false}var l=$("#table-contact");var d=l.children("tbody");var i=d.children("tr").length;d.append("<tr>"+"<th scope='row'>"+i+"</th>"+"<td>"+t+"</td>"+"<td>"+e+"</td>"+"<td>"+o+"</td>"+"<td>"+r+"</td>"+"<td>"+n+"</td>"+"<td><button type='button' class='btn btn-sm btn-success' value="+i+" onclick='table_del(this)'>删除</button></td>"+"</tr>");a.modal("hide")}function ajaxContactAdd(a){var t=$("#contact-add-modal");var e={project_id:a,name:t.find(".modal-body input[name='contact-name']").val(),pos:t.find(".modal-body input[name='contact-pos']").val(),tel:t.find(".modal-body input[name='contact-tel']").val(),mobile:t.find(".modal-body input[name='contact-mobile']").val(),mail:t.find(".modal-body input[name='contact-mail']").val()};if(checkContact(e)){var o="/crm/ajax/contact/add/";$.getJSON(o,e,function(a){if(a["msg"]=="0"){t.modal("hide");location.reload()}else{alert(a["msg"])}})}}function show_contact_edit(a){var t=$(a).val();var e=$("#contact-edit-modal");e.modal("show");var o=t.split(",");var r=o[0];var n=o[1];var l=GetTableData("#table-contact");var d=l[n-1];e.find(".modal-body input[name='contact-name']").val(d[0]);e.find(".modal-body input[name='contact-pos']").val(d[1]);e.find(".modal-body input[name='contact-tel']").val(d[2]);e.find(".modal-body input[name='contact-mobile']").val(d[3]);e.find(".modal-body input[name='contact-mail']").val(d[4]);e.find(".modal-footer button").val(r)}function contact_edit(a){var t=$(a).val();var e=$("#contact-edit-modal");var o={contact_id:t,name:e.find(".modal-body input[name='contact-name']").val(),pos:e.find(".modal-body input[name='contact-pos']").val(),tel:e.find(".modal-body input[name='contact-tel']").val(),mobile:e.find(".modal-body input[name='contact-mobile']").val(),mail:e.find(".modal-body input[name='contact-mail']").val()};if(checkContact(o)){var r="/crm/ajax/contact/edit/";$.getJSON(r,o,function(a){if(a["msg"]==0){e.modal("hide");location.reload()}else{alert(a["msg"])}})}}function show_contact_del(a){var t=$(a).val();var e=$("#confirm-modal");e.modal("show");var o=t.split(",");var r=o[0];var n=o[1];e.find(".modal-title strong").html("删除联系人");e.find(".modal-body").html("<h5>确认要删除<strong>"+n+"</strong>吗？</h5>");e.find(".modal-footer button[class='btn btn-success']").attr("onclick","contact_del(this)");e.find(".modal-footer button[class='btn btn-success']").attr("value",r)}function contact_del(a){var t=$("#confirm-modal");var e=$(a).val();var o="/crm/ajax/contact/del/";$.getJSON(o,{contact_id:e},function(a){if(a["msg"]==0){t.modal("hide");location.reload()}else{var e=t.find(".modal-body strong").html();t.find(".modal-body").html("<h5>无法删除<strong>"+e+"</strong></h5>"+"<p style='color:red;'>"+a["msg"]+"</p>")}})}function ajax_project_add(){var a=$("input[name='project-name']").val();if(!a){alert("项目名称不能为空！");return}var t=$("select[name='customer-name']").val();var e=getChecked("product");if(!e){alert("至少选择一个产品!");return}var o=$("select[name='priority']").val();var r=$("textarea[name='notes']").val();if(t){if(a){var n=GetTableData("#table-contact");var l={project_name:a,customer_id:t,products_id:e,priority:o,notes:r,contacts:n};$.ajax({type:"POST",url:"/crm/ajax/project/add/",contentType:"application/json; charset=utf-8",data:JSON.stringify(l),dataType:"json",success:function(a){if(a["msg"]=="0"){backpage()}else{alert(a["msg"])}},error:function(){alert("添加项目失败！")}})}else{alert("请填写项目名称！")}}else{alert("您还没有跟进任何客户,无法添加项目！");backpage()}}function ajax_project_edit(a){var t=$("#project-edit-form");var e=t.find("input[name='project-name']").val();if(!e){alert("项目名称不能为空！");return}var o=t.find("select[name='customer-name']").val();var r=getChecked("product");if(!r){alert("至少选择一个产品!");return}var n=t.find("select[name='priority']").val();var l=getChecked("businessman");var d=t.find("textarea[name='notes']").val();var i={project_id:a,project_name:e,customer_id:o,priority:n,products_id:r,notes:d,businessmans_id:l};var s="/crm/ajax/project/edit/";$.getJSON(s,i,function(a){if(a["msg"]=="0"){location.href="/crm/projects/0/0/0/0/"}else{alert(a["msg"])}})}function show_project_del(a,t){var e=$("#confirm-modal");e.modal("show");e.find(".modal-title strong").html("删除项目");e.find(".modal-body").html("<h4>确认要删除<strong>"+t+"</strong>吗？</h4>");e.find(".modal-footer button").val(a)}function project_del(a){var t=$("#confirm-modal");var e=$(a).val();var o="/crm/ajax/project/del/";$.getJSON(o,{project_id:e},function(a){if(a["msg"]=="0"){t.modal("hide");location.reload()}else{alert(a["msg"])}})}function show_update_progress(a){var t=$("#update-progress-modal");t.modal("show");var e=$(a).val();var o=e.split(",");var r=o[0];var n=o[1];var l=o[2];if(l!=undefined){if(l==0){l=1}t.find(".modal-body select[name='progress']").val(l)}t.find(".modal-title strong").html(n+"进度更新");t.find(".modal-footer button").val(r)}function update_progress(a){var t=$(a).val();var e=$("#update-progress-modal");var o=e.find(".modal-body");var r=o.find("select[name='progress']").val();var n=o.find("textarea[name='description']").val();var l=o.find("textarea[name='plan']").val();var d=o.find("input[name='datetime']").val();if(n){var i={project_id:t,progress:r,description:n,plan:l,updatetime:d};var s="/crm/ajax/progress/add/";$.post(s,JSON.stringify(i),function(a){if(a["msg"]=="0"){e.modal("hide");location.reload()}else{alert(a["msg"])}},"json")}else{alert("请简单填写项目进展！")}}function show_progress_add(a){var t=$("#progress-modal");t.modal("show");var e=$(a).val();var o=e.split(",");var r=o[0];var n=o[1];if(n==0){n=1}t.find(".modal-title strong").html("添加项目进度");t.find(".modal-body select[name='progress']").val(n);t.find(".modal-body textarea[name='description']").val("");t.find(".modal-body textarea[name='plan']").val("");t.find(".modal-body input[name='datetime']").val("");t.find(".modal-footer button").val(r);t.find(".modal-footer button[class='btn btn-success']").attr("onclick","progress_add(this)")}function show_progress_edit(a){var t=$("#progress-modal");t.modal("show");var e=$(a).val();var o=e.split(",");var r=o[0];var n=o[1];var l=GetTableData("#table-progress");var d=l[n-1];t.find(".modal-title strong").html("编辑进度");var i={"准备":1,"接洽":2,"测试/试用":3,"谈判":4,"上线":5,"售后":6};t.find(".modal-body select[name='progress']").val(i[d[1]]);t.find(".modal-body textarea[name='description']").val(d[2]);t.find(".modal-body textarea[name='plan']").val(d[3]);t.find(".modal-body input[name='datetime']").val(d[0]);t.find(".modal-footer button").val(r);t.find(".modal-footer button[class='btn btn-success']").attr("onclick","progress_edit(this)")}function progress_edit(a){var t=$(a).val();var e=$("#progress-modal");var o=e.find(".modal-body");var r=o.find("select[name='progress']").val();var n=o.find("textarea[name='description']").val();var l=o.find("textarea[name='plan']").val();var d=o.find("input[name='datetime']").val();if(n){var i={progress_id:t,progress:r,description:n,plan:l,updatetime:d};var s="/crm/ajax/progress/edit/";$.post(s,JSON.stringify(i),function(a){if(a["msg"]=="0"){e.modal("hide");location.reload()}else{alert(a["msg"])}},"json")}else{alert("请简单填写项目进展！")}}function show_progress_del(a){var t=$(a).val();var e=$("#confirm-modal");e.modal("show");e.find(".modal-title strong").html("删除进度");e.find(".modal-body").html("<h5>确认要删除这条进度信息吗？</h5>");e.find(".modal-footer button[class='btn btn-success']").attr("onclick","progress_del(this)");e.find(".modal-footer button[class='btn btn-success']").attr("value",t)}function show_mark_modal(a,t){var e=$("#mark-modal");e.modal("show");e.find(".modal-body textarea[name=content]").val(t);e.find(".modal-footer button[class='btn btn-success']").attr("value",a)}function mark_edit(a){var t=$(a).val();var e=$("#mark-modal");var o=e.find(".modal-body textarea[name=content]").val();if(o){var r={progress_id:t,content:o};var n="/crm/ajax/mark/edit/";$.post(n,JSON.stringify(r),function(a){if(a["msg"]=="0"){e.modal("hide");location.reload()}else{alert(a["msg"])}},"json")}else{alert("请填写标注内容！")}}function getTestApplyData(){var a=$("#analyser").val();var t=$("#amount-data").val();var e=$("#goal").val();var o=$("#fields").val();var r=$("#notes").val();var n=$("#contact").val();var l=getCheckedArray("test-result");var d=getCheckedArray("overdue-state");return{analyser_id:a,amount_data:t,goal:e,fields:o,notes:r,test_result_id:l,overdue_state:!(d.length==0),contact_id:n}}function checkTestApplyData(a){if(!a.contact_id){alert("缺少联系人");return false}else if(a.amount_data===""){alert("请填写测试数据量");return false}else if(a.goal===""){alert("请填写本次测试目标");return false}else if(a.fields===""){alert("请填写客户提供的测试字段");return false}else if(a.test_result_id.length==0){alert("请选择测试结果要求");return false}return true}function testApplyAdd(a){loading(true);var t=getTestApplyData();if(checkTestApplyData(t)){t.project_id=a;var e="/crm/test-apply/add/";$.post(e,JSON.stringify(t),function(a){if(a["msg"]==0){backpage()}else{loading(false);alert(a["msg"])}},"json")}else{loading(false)}}function testApplyEdit(a){loading(true);var t=getTestApplyData();if(checkTestApplyData(t)){t.test_apply_id=a;var e="/crm/test-apply/edit/";$.post(e,JSON.stringify(t),function(a){if(a["msg"]==0){backpage()}else{loading(false);alert(a["msg"])}},"json")}else{loading(false)}}function showTestApplyProgressAddModal(a,t,e){var o=$("#update-progress-modal");var r=$("#progress_dom");if(t){r.hide();$("#progress").val(4);o.find(".modal-title strong").html("理由或建议")}else{r.show();$("#progress").val(e);o.find(".modal-title strong").html("更新进度")}o.find(".modal-footer button[class='btn btn-success']").attr("onclick",'testApplyProgressAdd("'+a+'")');o.modal("show")}function testApplyProgressAdd(a){var t=$("#update-progress-modal");var e=$("#progress").val();var o=$("#description").val();if(!o){alert("请简单填写描述信息");return false}$.getJSON(a,{progress:e,description:o},function(a){if(a["msg"]==0){t.modal("hide");location.href="/crm/test-apply/list/"+e+"/0/0/"}else{alert(a["msg"])}})}function showDeleteConfirmModal(a){var t=$("#confirm-modal");t.modal("show");t.find(".modal-title strong").html("删除测试申请");t.find(".modal-body").html("<h5>确认要删除这个申请吗？</h5>");t.find(".modal-footer button[class='btn btn-success']").attr("value",a)}function testApplyDel(a){var t=$("#confirm-modal");var e=$(a).val();var o="/crm/test-apply/del/";$.getJSON(o,{test_apply_id:e},function(a){if(a["msg"]=="0"){t.modal("hide");location.href="/crm/test-apply/list/4/0/0/"}else{alert(a["msg"])}})}function showSelectProductModel(a){var t=$("#select-product-modal");t.find(".modal-footer button[class='btn btn-success']").attr("value",a);var e=t.find(".modal-body select[name='product']").get(0);e.options.length=0;var o="/crm/ajax/get-project-products/";$.getJSON(o,{projectid:a},function(a){if(a["msg"]==0){var o=a["products"];for(var r in o){e.options.add(new Option(o[r].name,o[r].id))}t.modal("show")}else{alert(a["msg"])}})}function locateImpApply(a){var t=$(a).val();var e=$("#select-product-modal");e.modal("hide");var o=e.find(".modal-body select[name='product']").val();location.href="/crm/imp-apply/add/"+t+"/"+o+"/"}function showImpApplyProgressAddModal(a,t){var e=$("#update-progress-modal");e.find(".modal-footer button[class='btn btn-success']").attr("onclick",'impApplyProgressAdd("'+a+'",'+t+")");e.modal("show")}function impApplyProgressAdd(a,t){var e=$("#update-progress-modal");var o=$("#description").val();$.getJSON(a,{progress:t,description:o},function(a){if(a["msg"]==0){e.modal("hide");var o=1;if(t==40){o=5}else if(t==45){o=6}else if(t==50){o=7}else if(t==13){o=8}location.href="/crm/imp-apply/list/"+o+"/0/0/"}else{alert(a["msg"])}})}function showImpApplyDelModal(a){var t=$("#confirm-modal");t.modal("show");t.find(".modal-title strong").html("删除交付申请");t.find(".modal-body").html("<h5>确认要删除这个交付申请吗？</h5>");t.find(".modal-footer button[class='btn btn-success']").attr("value",a)}function impApplyDel(a){var t=$("#confirm-modal");var e=$(a).val();var o="/crm/imp-apply/del/";$.getJSON(o,{imp_apply_id:e},function(a){if(a["msg"]==0){t.modal("hide");location.href="/crm/imp-apply/list/5/0/0/"}else{alert(a["msg"])}})}function impApplyFreeDateStartEdit(a){var t=$("#update-free-date-start-modal");var e="/crm/imp-apply/free-date-start/edit/"+a;var o=$("#free-date-start-model").val();$.getJSON(e,{date:o},function(a){if(a["msg"]==0){t.modal("hide");$("#free-date-start-td").text(o)}else{alert(a["msg"])}})}